name: Build HTML5

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  html5:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo (sanity)
        run: |
          ls -la
          test -f Project.xml || (echo "âŒ Missing Project.xml in repo root" && exit 1)

      - name: Install Haxe
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: '4.2.5'

      - name: Haxelib setup and deps (pin Kade-era versions)
        shell: bash
        run: |
          set -euxo pipefail

          # point haxelib to a real dir
          mkdir -p "$HOME/haxelib"
          echo "$HOME/haxelib" > "$HOME/.haxelib"
          haxelib config

          # ---- install specific versions (Flixel 4.x stack) ----
          haxelib install lime 8.0.2
          haxelib install openfl 9.1.0
          haxelib install flixel 4.11.0
          haxelib install flixel-addons 2.11.0
          haxelib install flixel-ui 2.5.0
          haxelib install polymod 1.6.1
          haxelib install hscript 2.4.0
          haxelib install actuate
          haxelib install flixel-tools
          haxelib install extension-webm
          haxelib install newgrounds

          # ---- select those versions explicitly ----
          haxelib set lime 8.0.2
          haxelib set openfl 9.1.0
          haxelib set flixel 4.11.0
          haxelib set flixel-addons 2.11.0
          haxelib set flixel-ui 2.5.0
          haxelib set polymod 1.6.1
          haxelib set hscript 2.4.0

          haxelib list
          haxelib run lime setup -y || true
          haxelib run openfl setup -y || true

      - name: Build HTML5 (final)
        env:
          OPENFL_DEFAULT_PROJECT: Project.xml
        run: haxelib run openfl build html5 -final

      - name: Upload HTML5 build artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: html5-build
          path: Export/html5/bin/**
          if-no-files-found: error
